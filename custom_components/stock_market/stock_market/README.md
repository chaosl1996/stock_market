# 股票市场信息集成

这是一个Home Assistant自定义集成，用于通过雅虎金融API获取和显示全球股票市场的实时行情数据。

## 功能特性

- 支持添加多个股票代码
- 显示股票的实时价格、涨跌幅、涨跌额等关键信息
- 支持全球多个股票市场（上证、深证、港股、美股等）
- 支持自定义刷新间隔
- 动态显示货币单位
- 遵循Home Assistant的标准单位属性规范

## 安装方法

### 通过HACS（推荐）

1. 打开HACS
2. 点击"集成"
3. 点击右上角的三个点，选择"自定义存储库"
4. 添加此存储库的URL
5. 搜索"股票市场信息"并安装

### 手动安装

1. 下载此集成的ZIP文件
2. 解压并将`stock_market`文件夹复制到Home Assistant的`config/custom_components/`目录下
3. 重启Home Assistant

## 配置方法

1. 在Home Assistant中，前往"配置" > "集成" > "添加集成"
2. 搜索并选择"股票市场信息"
3. 在配置表单中填写以下信息：
   - 股票符号：完整的雅虎金融股票符号，如000001.SS（上证）、AAPL.US（美股）、0700.HK（港股）
   - 股票名称：自定义的股票名称
4. 点击"提交"完成配置

**示例股票符号**：
- 上证指数：000001.SS
- 深圳成指：399001.SZ
- 贵州茅台：600519.SS
- 阿里巴巴：BABA.US
- 腾讯控股：0700.HK
- 苹果公司：AAPL.US

## 实体属性

每个股票实体提供以下属性：

- **状态**：当前价格（动态货币单位）
- **额外属性**：
  - stock_name: 股票名称
  - stock_code: 股票代码
  - change_percent: 涨跌幅（%）
  - change_amount: 涨跌额
  - prev_close: 昨收价
  - volume: 成交量
  - regular_market_volume: 常规市场成交量
  - market_cap: 市值
  - average_volume: 平均成交量
  - market_state: 市场状态
  - quote_type: 报价类型
  - currency: 货币类型
  - timestamp: 数据更新时间

## 自定义选项

在集成配置完成后，您可以通过以下步骤调整刷新间隔：

1. 前往"配置" > "集成"
2. 找到已配置的"股票市场信息"集成
3. 点击"选项"
4. 调整"数据刷新间隔（秒）"（最小值30秒，最大值86400秒）
5. 点击"提交"保存更改

## 注意事项

- 本集成使用雅虎金融API获取数据，仅供个人学习和研究使用
- 数据刷新频率过高可能导致API访问限制
- 建议设置合理的刷新间隔（默认10800秒，即3小时）
- 雅虎金融API可能受到地域限制，某些地区可能无法访问

## 故障排除

### 常见问题

1. **实体状态显示为"未知"**
   - 检查股票代码和市场类型是否正确
   - 等待几分钟，让集成有时间获取数据
   - 检查Home Assistant日志中的错误信息

2. **无法添加集成**
   - 确保您的Home Assistant版本符合要求（2023.8.0或更高）
   - 检查custom_components目录中的文件是否完整

## 更新日志

### 0.2.0
- 重大更新：将API从东方财富网切换到雅虎金融
- 支持全球多个股票市场
- 动态显示货币单位
- 新增市值、平均成交量等属性
- 简化了配置流程
- 修复：实现了crumb和cookie认证，解决了401未授权错误
- 修复：添加了对大响应头的支持，解决了"Got more than 8190 bytes"错误
- 优化：修改了timestamp属性的显示格式，从Unix时间戳改为可读的时间日期格式
- 优化：调整了最小刷新间隔，从600秒改为30秒，与参考集成保持一致
- 优化：改进了错误处理和重试机制，提高了集成的稳定性

### 0.1.1
- 修复：解决设备名称配置问题，确保设备名称与实体名称（股票名称）保持一致
- 优化：移除不再使用的常量导入

### 0.1.0
- 初始版本发布
- 支持添加多个股票代码
- 显示实时价格、涨跌幅、成交量等关键数据
- 支持自定义刷新间隔

## 感谢

本集成基于雅虎金融的公开API，感谢雅虎金融提供的服务。